{% extends "ui/base.html" %}
{% block title %}API 통합 테스트{% endblock %}

{% block content %}
<h2>API 통합 테스트</h2>

<form method="post" action="/ui/api-test" style="display:grid;gap:12px;max-width:900px;">
  {% if current_user_login %}
    <div style="font-size:14px;">
      현재 로그인: <b>{{ current_user_login }}</b> (id: {{ current_user_id }})
    </div>
    <input type="hidden" name="user_id" value="{{ current_user_id }}" />
  {% else %}
    <div style="display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center;">
      <label>user_id</label>
      <input type="number" name="user_id" placeholder="예: 1" />
    </div>
  {% endif %}

  <div style="display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center;">
    <label>model_id</label>
    <input type="text" name="model_id" value="starcoder-15b" required />
  </div>

  <div style="display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center;">
    <label>language</label>
    <input type="text" name="language" value="python" required />
  </div>

  <div style="display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center;">
    <label>trigger</label>
    <input type="text" name="trigger" value="manual" required />
  </div>


  <div style="display:grid;grid-template-columns:160px 1fr;gap:8px;">
    <label>code</label>
    <textarea name="code" rows="8" placeholder="여기에 코드 입력" required>def add(a,b): return a+b</textarea>
  </div>

  <label>criteria (쉼표로 구분)</label>
  <input
    type="text"
    name="criteria"
    value=""
  />

  <details style="margin-top:8px;">
    <summary>Authorization 옵션 (토큰 직접 입력)</summary>
    <div style="margin-top:8px;display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center;">
      <label>JWT 토큰</label>
      <input type="text" name="token" placeholder="Bearer 없이 토큰만 입력" />
    </div>
    <p style="color:#777;margin:6px 0 0;">
      디버그 토큰 발급: <code>GET /auth/github/debug/mint?user_id=&lt;ID&gt;</code><br/>
      쿠키(<code>access_token</code>)가 있으면 헤더 없이도 인증됩니다.
    </p>
  </details>

  <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
    <button type="submit" class="button">/v1/reviews/request 호출</button>
    <a class="button" href="/ui/api-test">초기화</a>
  </div>
</form>

{% if resp is not none %}
  <hr/>
  <h3>보낸 페이로드</h3>
  <pre style="background:#222;color:#ddd;padding:10px;border-radius:8px;overflow:auto;white-space:pre-wrap;">{{ sent_pretty | safe }}</pre>

  <p style="color:#666;">Authorization 사용: {{ '예' if used_authorization else '아니오' }}</p>
{% endif %}
{% endblock %}
