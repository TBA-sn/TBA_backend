name: Deploy Backend to EC2

on:
  workflow_dispatch:  # GitHub Actions 화면에서 수동 실행

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) EC2로 코드 전체 복사
      - name: Copy backend to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: ${{ secrets.EC2_APP_PATH }}

      # 2) EC2에서 가상환경 + 의존성 설치 + 서비스 재시작
      - name: SSH to EC2 and restart backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ${{ secrets.EC2_APP_PATH }}

            # (원하면 아래 venv 부분은 이미 venv가 있다면 생략 가능)
            python3 -m venv .venv
            source .venv/bin/activate

            pip install -U pip
            pip install -r requirements.txt

            # 여기부터는 너 서버 환경에 맞게 수정
            # 예시 1) systemd 서비스로 돌리는 경우
            # sudo systemctl restart tba-backend.service

            # 예시 2) uvicorn 단독으로 돌릴 때 (screen/tmux/pm2 등 쓰면 거기에 맞게)
            # pkill -f "uvicorn app.main:app" || true
            # nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &
